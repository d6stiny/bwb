{
    admin off
    auto_https disable_redirects
}

:80 {
    # Redirect HTTP to HTTPS
    redir https://{host}{uri} permanent

    # PHP handling
    php_fastcgi unix//run/php/php-fpm.sock {
        index index.php
    }

    # Clean URLs - remove .php extension
    rewrite {
        to {path} {path}.php
    }

    # Serve static files
    file_server

    # Block sensitive files/directories
    @blocked {
        path /.* /composer.json /composer.lock /*.sql /*.yml /*.config.php /README.md
        path /controllers/* /config/* /vendor/*
        path /Caddyfile
    }
    respond @blocked 403

    # Security headers
    header {
        -Server
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
    }

    # Prevent directory listing
    encode gzip
    templates
}

:443 {
    tls internal

    # Same config as HTTP but without redirect
    php_fastcgi unix//run/php/php-fpm.sock {
        index index.php
    }

    rewrite {
        to {path} {path}.php
    }

    file_server

    @blocked {
        path /.* /composer.json /composer.lock /*.sql /*.yml /*.config.php /README.md
        path /controllers/* /config/* /vendor/*
        path /Caddyfile
    }
    respond @blocked 403

    header {
        -Server
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
    }

    encode gzip
    templates
}